<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Doggy Desserts â€“ Monthly Dog Competition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #fffbe9;
    }
    .popup {
      position: fixed;
      top: 50px;
      left: 50%;
      transform: translateX(-50%);
      background: #25b3ad;
      color: #fff;
      padding: 12px 28px;
      border-radius: 2rem;
      font-size: 1.1rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s;
    }
    .popup.show {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body>
  <header class="bg-[#25b3ad] py-8 text-center">
    <h1 class="text-white font-bold text-4xl mb-2" style="font-family:'Poppins',sans-serif;">Doggy Desserts</h1>
    <div class="text-white text-xl font-semibold">Monthly Dog Photo Competition</div>
    <div class="text-white text-base mt-2">Vote for your favourite doggy. Each person can vote once per dog.</div>
  </header>
  <div class="min-h-screen flex items-center justify-center py-10">
    <div class="bg-white rounded-2xl shadow-xl px-8 py-10 max-w-5xl w-full">
      <div id="dogs" class="grid grid-cols-1 md:grid-cols-3 gap-10 justify-items-center"></div>
    </div>
  </div>
  <div id="popup" class="popup">Thanks for voting!</div>
  <script>
    // Sheet and Script URLs (update if yours are different)
    const SHEET_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQBmlL5KZtwZnC7FVy6qUbjIgusWS53DIoAK2pMyDM9f8xuC5_gzzNlYBTt9ncMzK5uxoV1H5KMz8Ap/pub?output=csv';
    const VOTE_API = 'https://script.google.com/macros/s/AKfycbyqMg0l0LXz9zUwSj1dn2HXG2LmMBAVp_cVAXgXOiXF27qvoLi2UaPJgN3kFZEVppw/exec';
    const votedKey = 'doggyVotes';

    function getVoted() {
      try { return JSON.parse(localStorage.getItem(votedKey) || '[]'); }
      catch { return []; }
    }
    function setVoted(arr) {
      localStorage.setItem(votedKey, JSON.stringify(arr));
    }
    function showPopup(msg) {
      const pop = document.getElementById('popup');
      pop.textContent = msg;
      pop.classList.add('show');
      setTimeout(() => pop.classList.remove('show'), 1500);
    }

    function fetchDogs() {
      return fetch(SHEET_CSV)
        .then(r => r.text())
        .then(csv => {
          return csv.trim().split('\n').slice(1).map(row => {
            const [id, name, votes, date, image] = row.split(',');
            return {
              id: id.trim(),
              name: name.trim(),
              votes: parseInt(votes, 10) || 0,
              img: image.trim()
            };
          });
        });
    }

    function renderDogs(dogs) {
      const voted = getVoted();
      const dogsDiv = document.getElementById('dogs');
      dogsDiv.innerHTML = '';
      dogs.forEach(dog => {
        // Card
        const card = document.createElement('div');
        card.className = "flex flex-col items-center bg-[#fcfcfd] rounded-2xl shadow-lg p-7 w-[270px]";

        // Dog Image
        const img = document.createElement('img');
        img.src = dog.img;
        img.alt = dog.name;
        img.className = "rounded-xl mb-5 object-cover w-[180px] h-[180px] border bg-[#ececec]";
        card.appendChild(img);

        // Name
        const name = document.createElement('div');
        name.className = "text-2xl font-bold mb-5 text-black text-center";
        name.textContent = dog.name;
        card.appendChild(name);

        // Vote Row
        const voteRow = document.createElement('div');
        voteRow.className = "flex flex-row items-center justify-center gap-2 w-full mb-4";
        // Heart
        const heart = document.createElement('span');
        heart.innerHTML = voted.includes(dog.id) ? 
          `<svg fill="#e53935" viewBox="0 0 24 24" width="26" height="26"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`
          : `<svg fill="none" stroke="#bdbdbd" stroke-width="2" viewBox="0 0 24 24" width="26" height="26"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`;
        heart.className = "mr-1";
        voteRow.appendChild(heart);

        // Vote Button
        const voteBtn = document.createElement('button');
        voteBtn.className = "ml-2 px-7 py-1.5 bg-[#25b3ad] text-white font-semibold rounded-full text-lg shadow transition disabled:bg-[#eee] disabled:text-[#bdbdbd]";
        voteBtn.textContent = voted.includes(dog.id) ? "Voted" : "Vote";
        voteBtn.disabled = voted.includes(dog.id);
        voteRow.appendChild(voteBtn);

        // Vote Count
        const voteCount = document.createElement('span');
        voteCount.className = "block ml-2 text-base text-gray-500";
        voteCount.textContent = `Votes: ${dog.votes}`;
        voteRow.appendChild(voteCount);

        // Vote logic
        voteBtn.onclick = () => {
          voteBtn.disabled = true;
          voteBtn.textContent = "Voted";
          heart.innerHTML = `<svg fill="#e53935" viewBox="0 0 24 24" width="26" height="26"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`;
          let votesNow = parseInt(voteCount.textContent.replace('Votes: ',''), 10) + 1;
          voteCount.textContent = `Votes: ${votesNow}`;
          let votedArr = getVoted();
          votedArr.push(dog.id);
          setVoted(votedArr);
          showPopup('Thanks for voting!');
          // Register vote in Google Sheet
          fetch(VOTE_API, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'id=' + encodeURIComponent(dog.id)
          });
        };

        card.appendChild(voteRow);

        // Share Row
        const shareRow = document.createElement('div');
        shareRow.className = "flex flex-row items-center justify-center gap-2 w-full";
        // Share icon
        const shareIcon = document.createElement('span');
        shareIcon.innerHTML = `<svg fill="#25b3ad" viewBox="0 0 24 24" width="24" height="24"><path d="M18 8.59l-7.17-7.17-1.41 1.41L15.17 8H5v2h10.17l-5.75 5.75 1.41 1.41L18 10.41z"/></svg>`;
        shareRow.appendChild(shareIcon);

        // Share Button
        const shareBtn = document.createElement('button');
        shareBtn.className = "ml-2 px-6 py-1 bg-[#e1f7f6] text-[#25b3ad] font-semibold rounded-full text-base shadow";
        shareBtn.textContent = "Share";
        shareBtn.onclick = () => {
          const url = `${window.location.origin}${window.location.pathname}#dog-${dog.id}`;
          navigator.clipboard.writeText(url);
          showPopup("Link copied!");
        };
        shareRow.appendChild(shareBtn);

        card.appendChild(shareRow);

        // ID for anchor
        card.id = "dog-" + dog.id;

        dogsDiv.appendChild(card);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      fetchDogs().then(renderDogs);
    });
  </script>
</body>
</html>
